<?php
/**
 * @file
 * Code for the Sierragraphs feature.
 */

include_once 'sierragraphs.features.inc';

/**
 * Implements hook_field_widget_form_alter().
 */
function sierragraphs_field_widget_form_alter(&$element, &$form_state, $context) {
    // Hide certain fields during node create
    if(!isset($form_state['node']->nid)) {
        if(isset($element['#field_name'])) {
            $sierragraphs_fields = array('title', 'author', 'summary', 'material_type', 'isbn', 'data');
            hide_sierragraphs_fields($element, $sierragraphs_fields);

            // Add validation to bib_id
            if($element['#field_name'] == 'field_sierragraphs_bib_id') {
                $element['#element_validate'][] = 'sierragraphs_bib_id_validate';
            }
        }
        // Jacket field is special case
        if(isset($element[0]) && $element[0]['#field_name'] == 'field_sierragraphs_jacket') {
            $element['#access'] = FALSE;
        }
    }
    else { // Hide certain fields during node edit
        if(isset($element['#field_name'])) {
            $sierragraphs_fields = array('bib_id', 'material_type', 'isbn', 'data');
            hide_sierragraphs_fields($element, $sierragraphs_fields);
        }
    }
}

/*
 * Iterates through an array of fields to hide them
 */
function hide_sierragraphs_fields(&$element, $sierragraphs_fields) {
    foreach ($sierragraphs_fields as $field) {
        if ($element['#field_name'] == 'field_sierragraphs_'.$field) {
            $element['#access'] = FALSE;
        }
    }
}

/*
 * Implements hook_validate().
 */
function sierragraphs_bib_id_validate($element, &$form_state, $complete_form) {
    $bib_id = preg_match('/[0-9]{7}/', $element['value']['#value'], $matches);
    if (!$bib_id) {
        form_error($element, t('bib ID field must have a 7 digit bib number.'));
    }
    else { // Strip value down to bib_id
        form_set_value($element, array('value' => $matches[0]), $form_state);
    }
}